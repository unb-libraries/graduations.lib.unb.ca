<?php

/**
 * @file
 * Contains pomp_emeritus_linking.module.
 */

use Drupal\node\Entity\Node;
use Drupal\Core\Form\FormStateInterface;

/**
 * Implements hook_form_FORM_ID_alter().
 */
function pomp_emeritus_linking_form_node_professor_emeritus_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  foreach (array_keys($form['actions']) as $action) {
    if ($action != 'preview' && isset($form['actions'][$action]['#type']) &&
    $form['actions'][$action]['#type'] === 'submit') {
      $form['actions'][$action]['#submit'][] = 'pomp_emeritus_linking_link';
      array_unshift($form['actions'][$action]['#submit'], 'pomp_emeritus_linking_title');
    }
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function pomp_emeritus_linking_form_node_professor_emeritus_edit_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  foreach (array_keys($form['actions']) as $action) {
    if ($action != 'preview' && isset($form['actions'][$action]['#type']) &&
    $form['actions'][$action]['#type'] === 'submit') {
      $form['actions'][$action]['#submit'][] = 'pomp_emeritus_linking_link';
      array_unshift($form['actions'][$action]['#submit'], 'pomp_emeritus_linking_title');
    }
  }
}

/**
 * Method added as submit handler.
 */
function pomp_emeritus_linking_title(&$form, FormStateInterface $form_state) {
  $title = $form_state->getValue('field_recipient_name')[0]['value'];
  $form_state->setValue('title', $title);
}

/**
 * Method added as submit handler.
 */
function pomp_emeritus_linking_link(&$form, FormStateInterface $form_state) {
  $usr = \Drupal::currentUser()->id();
  $ses = \Drupal::service('session_manager')->getId();
  $pomp_emeritus_linking_parent_cer = 'parent_cer' . $usr . $ses;
  $cer_id = \Drupal::state()->get($pomp_emeritus_linking_parent_cer);
  \Drupal::state()->delete($pomp_emeritus_linking_parent_cer);

  if ($cer_id) {
    $emeritus_id = $form_state->get('nid');
    $emeritus_id_ref = ['target_id' => $emeritus_id];

    $query = \Drupal::entityQuery('node')
      ->condition('type', 'honorary_ceremony')
      ->condition('nid', $cer_id);
    $cers = $query->execute();

    foreach ($cers as $cer) {
      $cer_node = Node::load($cer);
      $ref_cer_emeritus = $cer_node->get('field_ref_ceremony_emeritus')->getValue();

      if (!in_array($emeritus_id_ref, $ref_cer_emeritus)) {
        $cer_node->field_ref_ceremony_emeritus->appendItem($emeritus_id_ref);
        $cer_node->save();
      }

      unset($cer_node);
    }
  }
}
